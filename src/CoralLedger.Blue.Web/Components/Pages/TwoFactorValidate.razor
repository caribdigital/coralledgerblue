@page "/2fa/validate"
@using System.ComponentModel.DataAnnotations
@using System.Net.Http.Json
@using CoralLedger.Blue.Web.Endpoints.Auth
@inject NavigationManager NavigationManager
@inject IHttpClientFactory HttpClientFactory
@inject IStringLocalizer<SharedResources> Localizer
@rendermode InteractiveServer

<PageTitle>@Localizer["TwoFactor_Validate_Title"] - CoralLedger Blue</PageTitle>

<div class="auth-page">
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <div class="two-factor-icon">
                    <i class="bi bi-shield-lock"></i>
                </div>
                <h1>@Localizer["TwoFactor_Validate_Title"]</h1>
                <p class="auth-subtitle">@Localizer["TwoFactor_Validate_Subtitle"]</p>
            </div>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="alert alert-danger" role="alert">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    @_errorMessage
                </div>
            }

            <EditForm Model="@_model" OnValidSubmit="@HandleValidate" FormName="2fa-validate-form">
                <DataAnnotationsValidator />

                @if (!_useRecoveryCode)
                {
                    <div class="form-group">
                        <label for="code">@Localizer["TwoFactor_Validate_Code"]</label>
                        <div class="code-input-wrapper">
                            <InputText id="code" class="form-control code-input" @bind-Value="_model.Code"
                                       placeholder="000000" maxlength="6" autocomplete="one-time-code"
                                       @oninput="OnCodeInput" />
                        </div>
                        <ValidationMessage For="@(() => _model.Code)" />
                        <small class="form-text">@Localizer["TwoFactor_Validate_CodeHint"]</small>
                    </div>
                }
                else
                {
                    <div class="form-group">
                        <label for="recoveryCode">@Localizer["TwoFactor_Validate_RecoveryCode"]</label>
                        <InputText id="recoveryCode" class="form-control" @bind-Value="_model.Code"
                                   placeholder="XXXXX-XXXXX" />
                        <ValidationMessage For="@(() => _model.Code)" />
                        <small class="form-text">@Localizer["TwoFactor_Validate_RecoveryCodeHint"]</small>
                    </div>
                }

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-block" disabled="@_isValidating">
                        @if (_isValidating)
                        {
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            <span>@Localizer["TwoFactor_Validate_Verifying"]...</span>
                        }
                        else
                        {
                            <i class="bi bi-shield-check"></i>
                            <span>@Localizer["TwoFactor_Validate_Verify"]</span>
                        }
                    </button>
                </div>
            </EditForm>

            <div class="auth-divider">
                <span>@Localizer["TwoFactor_Validate_Or"]</span>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-outline-secondary btn-block" @onclick="ToggleRecoveryCode">
                    @if (_useRecoveryCode)
                    {
                        <i class="bi bi-phone"></i>
                        <span>@Localizer["TwoFactor_Validate_UseAuthenticator"]</span>
                    }
                    else
                    {
                        <i class="bi bi-key"></i>
                        <span>@Localizer["TwoFactor_Validate_UseRecoveryCode"]</span>
                    }
                </button>
            </div>

            <div class="auth-footer">
                <p>
                    <a href="/login">
                        <i class="bi bi-arrow-left"></i>
                        @Localizer["TwoFactor_Validate_BackToLogin"]
                    </a>
                </p>
            </div>
        </div>
    </div>
</div>

@code {
    private TwoFactorModel _model = new();
    private bool _isValidating = false;
    private bool _useRecoveryCode = false;
    private string? _errorMessage;

    [SupplyParameterFromQuery]
    public Guid? UserId { get; set; }

    [SupplyParameterFromQuery]
    public string? ReturnUrl { get; set; }

    protected override void OnInitialized()
    {
        if (!UserId.HasValue)
        {
            NavigationManager.NavigateTo("/login");
        }
    }

    private void OnCodeInput(ChangeEventArgs e)
    {
        var value = e.Value?.ToString() ?? "";
        // Auto-submit when 6 digits entered
        if (!_useRecoveryCode && value.Length == 6 && value.All(char.IsDigit))
        {
            _model.Code = value;
            InvokeAsync(HandleValidate);
        }
    }

    private void ToggleRecoveryCode()
    {
        _useRecoveryCode = !_useRecoveryCode;
        _model.Code = string.Empty;
        _errorMessage = null;
    }

    private async Task HandleValidate()
    {
        if (!UserId.HasValue)
        {
            _errorMessage = "Invalid session. Please login again.";
            return;
        }

        _isValidating = true;
        _errorMessage = null;
        StateHasChanged();

        try
        {
            var httpClient = HttpClientFactory.CreateClient();
            httpClient.BaseAddress = new Uri(NavigationManager.BaseUri);

            var request = new Validate2FARequest(UserId.Value, _model.Code);
            var response = await httpClient.PostAsJsonAsync("/api/auth/2fa/validate", request);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<TwoFactorValidateResponse>();
                if (result?.Success == true)
                {
                    // 2FA validated - redirect to return URL or dashboard
                    var redirectUrl = string.IsNullOrEmpty(ReturnUrl) ? "/" : Uri.UnescapeDataString(ReturnUrl);
                    NavigationManager.NavigateTo(redirectUrl, forceLoad: true);
                }
                else
                {
                    _errorMessage = result?.Message ?? Localizer["TwoFactor_Validate_Error"];
                }
            }
            else
            {
                var problemDetails = await response.Content.ReadFromJsonAsync<Microsoft.AspNetCore.Mvc.ProblemDetails>();
                _errorMessage = problemDetails?.Detail ?? Localizer["TwoFactor_Validate_Error"];
            }
        }
        catch (Exception)
        {
            _errorMessage = Localizer["TwoFactor_Validate_ErrorGeneric"];
        }
        finally
        {
            _isValidating = false;
            StateHasChanged();
        }
    }

    public class TwoFactorModel
    {
        [Required(ErrorMessage = "Verification code is required")]
        public string Code { get; set; } = string.Empty;
    }
}
