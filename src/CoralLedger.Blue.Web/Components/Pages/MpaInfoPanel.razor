@* US-2.3.3: Enhanced MPA Info Panel with live data section *@
@inject IMediator Mediator
@inject ICoralReefWatchClient CrwClient

<div class="mpa-info-panel" role="complementary" aria-label="MPA Details">
    <div class="panel-header">
        <h3><i class="bi bi-info-circle" aria-hidden="true"></i> MPA Details</h3>
    </div>

    <div class="panel-body">
        @if (SelectedMpaId is null)
        {
            <div class="empty-state">
                <i class="bi bi-geo-alt" aria-hidden="true"></i>
                <p>Select a Marine Protected Area from the map or list to view details.</p>
            </div>
        }
        else if (_loading)
        {
            <div class="loading-state" aria-busy="true" aria-live="polite">
                @* Skeleton loading for MPA details *@
                <div class="skeleton-card">
                    <div class="skeleton-header"></div>
                    <div class="skeleton-line"></div>
                    <div class="skeleton-line short"></div>
                    <div class="skeleton-line medium"></div>
                </div>
                <span class="visually-hidden">Loading MPA details...</span>
            </div>
        }
        else if (_detail is not null)
        {
            @* MPA Header *@
            <div class="mpa-header">
                <h4>@_detail.Name</h4>
                @if (!string.IsNullOrEmpty(_detail.LocalName))
                {
                    <p class="local-name">@_detail.LocalName</p>
                }
                <div class="mpa-badges">
                    <span class="badge badge-status">@_detail.Status</span>
                    <span class="badge @GetProtectionBadgeClass(_detail.ProtectionLevel)">
                        @GetProtectionLabel(_detail.ProtectionLevel)
                    </span>
                </div>
            </div>

            @* Quick Stats *@
            <div class="mpa-stats">
                <div class="stat-item">
                    <span class="stat-label">Island Group</span>
                    <span class="stat-value">@_detail.IslandGroup</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Area</span>
                    <span class="stat-value font-mono">@_detail.AreaSquareKm.ToString("N1") km²</span>
                </div>
                @if (_detail.DesignationDate.HasValue)
                {
                    <div class="stat-item">
                        <span class="stat-label">Designated</span>
                        <span class="stat-value">@_detail.DesignationDate.Value.Year</span>
                    </div>
                }
                @if (!string.IsNullOrEmpty(_detail.ManagingAuthority))
                {
                    <div class="stat-item">
                        <span class="stat-label">Manager</span>
                        <span class="stat-value">@_detail.ManagingAuthority</span>
                    </div>
                }
                <div class="stat-item">
                    <span class="stat-label">Tracked Reefs</span>
                    <span class="stat-value">@_detail.ReefCount</span>
                </div>
            </div>

            @* US-2.3.3: Live Data Section - Coral Bleaching Status *@
            <section class="live-data-section" aria-labelledby="bleaching-heading">
                <h5 id="bleaching-heading">
                    <i class="bi bi-thermometer-high" aria-hidden="true"></i>
                    Coral Bleaching Status
                </h5>

                @if (_bleachingLoading)
                {
                    <div class="loading-indicator" aria-busy="true" aria-live="polite">
                        @* Skeleton for live data cards *@
                        <div class="live-data-grid">
                            <div class="skeleton-card">
                                <div class="skeleton-line short"></div>
                                <div class="skeleton-header" style="margin: 0.5rem 0;"></div>
                            </div>
                            <div class="skeleton-card">
                                <div class="skeleton-line short"></div>
                                <div class="skeleton-header" style="margin: 0.5rem 0;"></div>
                            </div>
                        </div>
                        <span class="visually-hidden">Loading bleaching data...</span>
                    </div>
                }
                else if (_bleachingError)
                {
                    <div class="error-state" role="alert">
                        <i class="bi bi-exclamation-triangle" aria-hidden="true"></i>
                        <span>@_bleachingErrorMessage</span>
                        <button class="btn-retry" @onclick="RetryBleachingDataAsync" aria-label="Retry loading bleaching data">
                            <i class="bi bi-arrow-clockwise"></i> Retry
                        </button>
                    </div>
                }
                else if (_bleachingData is not null)
                {
                    @* Live Data Cards *@
                    <div class="live-data-grid">
                        <div class="live-data-card">
                            <span class="data-label">Sea Surface Temp</span>
                            <span class="data-value">@_bleachingData.SeaSurfaceTemperature.ToString("F1")°C</span>
                            @if (_bleachingData.SstAnomaly != 0)
                            {
                                <span class="data-anomaly @(_bleachingData.SstAnomaly > 0 ? "anomaly-high" : "anomaly-low")">
                                    @(_bleachingData.SstAnomaly > 0 ? "+" : "")@_bleachingData.SstAnomaly.ToString("F1")° anomaly
                                </span>
                            }
                        </div>
                        <div class="live-data-card">
                            <span class="data-label">Degree Heating Week</span>
                            <span class="data-value @GetDhwClass(_bleachingData.DegreeHeatingWeek)">
                                @_bleachingData.DegreeHeatingWeek.ToString("F1")
                            </span>
                            <span class="data-unit">°C-weeks</span>
                        </div>
                    </div>

                    @* US-2.3.2: Alert Badge Integration *@
                    <div class="alert-status">
                        <span class="alert-label">Alert Level:</span>
                        <AlertBadge Level="@_bleachingData.AlertLevel" Size="AlertBadge.BadgeSize.Normal" />
                    </div>

                    @if (_bleachingData.HotSpot.HasValue && _bleachingData.HotSpot.Value > 0)
                    {
                        <div class="hotspot-warning" role="alert">
                            <i class="bi bi-exclamation-octagon-fill" aria-hidden="true"></i>
                            <span>HotSpot detected: +@_bleachingData.HotSpot.Value.ToString("F1")°C above threshold</span>
                        </div>
                    }

                    <div class="data-meta">
                        <small>
                            <i class="bi bi-clock" aria-hidden="true"></i> @_bleachingData.Date.ToString("yyyy-MM-dd")
                        </small>
                        <small>
                            <i class="bi bi-geo-alt" aria-hidden="true"></i>
                            @_detail.CentroidLatitude.ToString("F2")°N, @Math.Abs(_detail.CentroidLongitude).ToString("F2")°W
                        </small>
                    </div>
                }
                else
                {
                    <div class="no-data-state">
                        <i class="bi bi-dash-circle" aria-hidden="true"></i>
                        <span>Bleaching data unavailable</span>
                    </div>
                }
            </section>

            @* DHW Trend Section *@
            @if (_historyLoading)
            {
                <section class="trend-section">
                    <h5 id="trend-heading">
                        <i class="bi bi-graph-up" aria-hidden="true"></i>
                        30-Day DHW Trend
                    </h5>
                    <div class="loading-indicator" aria-busy="true" aria-live="polite">
                        @* Skeleton for trend chart *@
                        <div style="height: 60px; margin-bottom: 0.5rem;">
                            <div class="skeleton-line" style="height: 60px; width: 100%;"></div>
                        </div>
                        <span class="visually-hidden">Loading trend data...</span>
                    </div>
                </section>
            }
            else if (_historyData?.Count > 1)
            {
                <section class="trend-section" aria-labelledby="trend-heading">
                    <h5 id="trend-heading">
                        <i class="bi bi-graph-up" aria-hidden="true"></i>
                        30-Day DHW Trend
                    </h5>
                    <DhwSparkline Data="@_historyData" Height="60" ShowLegend="true" />
                    <div class="trend-dates">
                        <span>@_historyData.First().Date.ToString("MMM d")</span>
                        <span>@_historyData.Last().Date.ToString("MMM d")</span>
                    </div>
                    @if (!string.IsNullOrEmpty(GetTrendIndicator().text))
                    {
                        <div class="trend-badge">
                            <span class="badge @GetTrendIndicator().badgeClass">
                                <i class="bi @GetTrendIndicator().icon" aria-hidden="true"></i>
                                @GetTrendIndicator().text
                            </span>
                        </div>
                    }
                </section>
            }
            else if (_historyData?.Count == 1)
            {
                <section class="trend-section">
                    <div class="no-data-state">
                        <i class="bi bi-info-circle" aria-hidden="true"></i>
                        <span>Insufficient data for trend chart</span>
                    </div>
                </section>
            }

            @* Description *@
            @if (!string.IsNullOrEmpty(_detail.Description))
            {
                <section class="description-section">
                    <p>@_detail.Description</p>
                </section>
            }

            @* WDPA Link *@
            @if (!string.IsNullOrEmpty(_detail.WdpaId))
            {
                <div class="wdpa-id">
                    <small>WDPA ID: @_detail.WdpaId</small>
                </div>
            }

            @* Data Attribution *@
            <div class="attribution">
                <a href="https://coralreefwatch.noaa.gov" target="_blank" rel="noopener noreferrer">
                    <i class="bi bi-box-arrow-up-right" aria-hidden="true"></i>
                    NOAA Coral Reef Watch
                </a>
            </div>
        }
        else
        {
            <div class="error-state" role="alert">
                <i class="bi bi-exclamation-triangle" aria-hidden="true"></i>
                <h4>Failed to load MPA details</h4>
                <p>Unable to retrieve information for this Marine Protected Area</p>
                <button class="btn-retry" @onclick="async () => await OnParametersSetAsync()" aria-label="Retry loading MPA details">
                    <i class="bi bi-arrow-clockwise"></i> Try Again
                </button>
            </div>
        }
    </div>
</div>

<style>
    .mpa-info-panel {
        background: var(--color-surface-alt, #0C1B33);
        border-radius: var(--radius-base, 14px);
        border: 1px solid var(--color-border, rgba(255,255,255,0.18));
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .panel-header {
        padding: 1rem;
        border-bottom: 1px solid var(--color-border);
        background: rgba(46, 227, 255, 0.05);
    }

    .panel-header h3 {
        font-size: 0.9375rem;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--color-text, #F5FBFF);
    }

    .panel-header h3 i {
        color: var(--color-primary, #2EE3FF);
    }

    .panel-body {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
    }

    /* Empty and Loading States */
    .empty-state,
    .loading-state,
    .no-data-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        text-align: center;
        color: var(--color-text-muted);
    }

    .empty-state i,
    .no-data-state i {
        font-size: 2.5rem;
        margin-bottom: 0.75rem;
        opacity: 0.5;
    }

    .empty-state p {
        font-size: 0.875rem;
        margin: 0;
    }

    /* MPA Header */
    .mpa-header {
        margin-bottom: 1rem;
    }

    .mpa-header h4 {
        font-size: 1.125rem;
        font-weight: 700;
        margin: 0 0 0.25rem;
        color: var(--color-text);
    }

    .local-name {
        font-size: 0.8125rem;
        font-style: italic;
        color: var(--color-text-muted);
        margin: 0 0 0.5rem;
    }

    .mpa-badges {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.6875rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .badge-status {
        background: rgba(93, 226, 133, 0.2);
        color: #5DE285;
    }

    .badge-notake {
        background: rgba(220, 53, 69, 0.2);
        color: #dc3545;
    }

    .badge-high {
        background: rgba(253, 126, 20, 0.2);
        color: #fd7e14;
    }

    .badge-light {
        background: rgba(13, 202, 240, 0.2);
        color: #0dcaf0;
    }

    /* MPA Stats */
    .mpa-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--color-border);
    }

    .stat-item {
        display: flex;
        flex-direction: column;
        gap: 0.125rem;
    }

    .stat-label {
        font-size: 0.6875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--color-text-muted);
    }

    .stat-value {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--color-text);
    }

    .font-mono {
        font-family: 'JetBrains Mono', monospace;
    }

    /* Live Data Section */
    .live-data-section,
    .trend-section {
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--color-border);
    }

    .live-data-section h5,
    .trend-section h5 {
        font-size: 0.8125rem;
        font-weight: 600;
        margin: 0 0 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--color-text);
    }

    .live-data-section h5 i {
        color: var(--color-error, #FB7A6A);
    }

    .trend-section h5 i {
        color: var(--color-primary, #2EE3FF);
    }

    /* Loading Indicator */
    .loading-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        font-size: 0.8125rem;
        color: var(--color-text-muted);
    }

    .loading-indicator .spinner-border {
        width: 1rem;
        height: 1rem;
        border-width: 2px;
    }

    /* Error State */
    .error-state {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.5rem;
        padding: 0.75rem;
        background: rgba(251, 122, 106, 0.1);
        border-radius: 6px;
        font-size: 0.8125rem;
        color: var(--color-error, #FB7A6A);
    }

    .btn-retry {
        margin-left: auto;
        padding: 0.25rem 0.5rem;
        background: transparent;
        border: 1px solid currentColor;
        border-radius: 4px;
        color: inherit;
        font-size: 0.75rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .btn-retry:hover {
        background: rgba(251, 122, 106, 0.1);
    }

    /* Live Data Grid */
    .live-data-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
    }

    .live-data-card {
        background: var(--color-surface, #050C1A);
        border-radius: 8px;
        padding: 0.75rem;
        text-align: center;
    }

    .data-label {
        display: block;
        font-size: 0.6875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--color-text-muted);
        margin-bottom: 0.25rem;
    }

    .data-value {
        display: block;
        font-size: 1.25rem;
        font-weight: 700;
        font-family: 'JetBrains Mono', monospace;
        color: var(--color-text);
    }

    .data-value.dhw-critical {
        color: var(--color-error, #FB7A6A);
    }

    .data-value.dhw-warning {
        color: var(--color-warning, #F7C549);
    }

    .data-value.dhw-watch {
        color: var(--color-primary, #2EE3FF);
    }

    .data-value.dhw-safe {
        color: var(--color-success, #5DE285);
    }

    .data-anomaly {
        display: block;
        font-size: 0.6875rem;
        margin-top: 0.25rem;
    }

    .data-anomaly.anomaly-high {
        color: var(--color-error, #FB7A6A);
    }

    .data-anomaly.anomaly-low {
        color: var(--color-primary, #2EE3FF);
    }

    .data-unit {
        display: block;
        font-size: 0.6875rem;
        color: var(--color-text-muted);
    }

    /* Alert Status */
    .alert-status {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.75rem;
    }

    .alert-label {
        font-size: 0.8125rem;
        color: var(--color-text-muted);
    }

    /* HotSpot Warning */
    .hotspot-warning {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        background: rgba(251, 122, 106, 0.15);
        border-radius: 6px;
        border-left: 3px solid var(--color-error);
        font-size: 0.8125rem;
        color: var(--color-error, #FB7A6A);
        margin-bottom: 0.75rem;
    }

    /* Data Meta */
    .data-meta {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .data-meta small {
        font-size: 0.6875rem;
        color: var(--color-text-muted);
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    /* Trend Section */
    .trend-dates {
        display: flex;
        justify-content: space-between;
        margin-top: 0.25rem;
        font-size: 0.6875rem;
        color: var(--color-text-muted);
    }

    .trend-badge {
        margin-top: 0.5rem;
    }

    .trend-badge .badge {
        font-size: 0.75rem;
    }

    /* Description */
    .description-section {
        margin-bottom: 1rem;
    }

    .description-section p {
        font-size: 0.8125rem;
        color: var(--color-text-muted);
        margin: 0;
        line-height: 1.5;
    }

    /* WDPA ID */
    .wdpa-id {
        margin-bottom: 0.75rem;
    }

    .wdpa-id small {
        font-size: 0.6875rem;
        color: var(--color-text-muted);
        font-family: 'JetBrains Mono', monospace;
    }

    /* Attribution */
    .attribution {
        padding-top: 0.75rem;
        border-top: 1px solid var(--color-border);
    }

    .attribution a {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.75rem;
        color: var(--color-primary, #2EE3FF);
        text-decoration: none;
    }

    .attribution a:hover {
        text-decoration: underline;
    }

    /* Scrollbar styling */
    .panel-body::-webkit-scrollbar {
        width: 6px;
    }

    .panel-body::-webkit-scrollbar-track {
        background: transparent;
    }

    .panel-body::-webkit-scrollbar-thumb {
        background: var(--color-border);
        border-radius: 3px;
    }

    .panel-body::-webkit-scrollbar-thumb:hover {
        background: var(--color-text-muted);
    }
</style>

@code {
    [Parameter]
    public Guid? SelectedMpaId { get; set; }

    private MpaDetailDto? _detail;
    private bool _loading;
    private Guid? _loadedMpaId;
    private CrwBleachingData? _bleachingData;
    private bool _bleachingLoading;
    private bool _bleachingError;
    private string _bleachingErrorMessage = "";
    private IReadOnlyList<BleachingHistoryDto>? _historyData;
    private bool _historyLoading;

    protected override async Task OnParametersSetAsync()
    {
        if (SelectedMpaId != _loadedMpaId && SelectedMpaId.HasValue)
        {
            _loading = true;
            _bleachingData = null;
            _bleachingError = false;
            _bleachingErrorMessage = "";
            _historyData = null;
            _detail = await Mediator.Send(new GetMpaByIdQuery(SelectedMpaId.Value));
            _loadedMpaId = SelectedMpaId;
            _loading = false;

            await Task.WhenAll(
                LoadBleachingDataAsync(),
                LoadHistoryDataAsync());
        }
        else if (!SelectedMpaId.HasValue)
        {
            _detail = null;
            _loadedMpaId = null;
            _bleachingData = null;
            _bleachingError = false;
            _bleachingErrorMessage = "";
            _historyData = null;
        }
    }

    private async Task LoadBleachingDataAsync()
    {
        if (_detail is null) return;

        try
        {
            _bleachingLoading = true;
            _bleachingError = false;
            _bleachingErrorMessage = "";
            StateHasChanged();

            using var cts = new CancellationTokenSource(TimeSpan.FromSeconds(15));
            var yesterday = DateOnly.FromDateTime(DateTime.UtcNow.AddDays(-1));
            var result = await CrwClient.GetBleachingDataAsync(
                _detail.CentroidLongitude,
                _detail.CentroidLatitude,
                yesterday,
                cts.Token);

            if (result.Success && result.Value is not null)
            {
                _bleachingData = result.Value;
            }
            else if (result.Success && result.Value is null)
            {
                _bleachingError = true;
                _bleachingErrorMessage = "No bleaching data available for this location";
                _bleachingData = null;
            }
            else
            {
                _bleachingError = true;
                _bleachingErrorMessage = result.ErrorMessage ?? "Failed to load bleaching data";
                _bleachingData = null;
            }
        }
        catch (OperationCanceledException)
        {
            _bleachingError = true;
            _bleachingErrorMessage = "Request timed out. NOAA service may be slow.";
            _bleachingData = null;
        }
        catch (HttpRequestException)
        {
            _bleachingError = true;
            _bleachingErrorMessage = "Unable to reach NOAA service";
            _bleachingData = null;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading bleaching data: {ex.Message}");
            _bleachingError = true;
            _bleachingErrorMessage = "Failed to load bleaching data";
            _bleachingData = null;
        }
        finally
        {
            _bleachingLoading = false;
            StateHasChanged();
        }
    }

    private async Task RetryBleachingDataAsync()
    {
        await LoadBleachingDataAsync();
    }

    private string GetProtectionBadgeClass(string level) => level switch
    {
        "NoTake" => "badge-notake",
        "HighlyProtected" => "badge-high",
        "LightlyProtected" => "badge-light",
        _ => ""
    };

    private string GetProtectionLabel(string level) => level switch
    {
        "NoTake" => "No-Take Zone",
        "HighlyProtected" => "Highly Protected",
        "LightlyProtected" => "Lightly Protected",
        _ => level
    };

    private string GetDhwClass(double dhw) => dhw switch
    {
        >= 8 => "dhw-critical",
        >= 4 => "dhw-warning",
        >= 1 => "dhw-watch",
        _ => "dhw-safe"
    };

    private async Task LoadHistoryDataAsync()
    {
        if (_loadedMpaId is null) return;

        try
        {
            _historyLoading = true;
            StateHasChanged();

            _historyData = await Mediator.Send(new GetMpaBleachingHistoryQuery(_loadedMpaId.Value, 30));
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading history data: {ex.Message}");
            _historyData = null;
        }
        finally
        {
            _historyLoading = false;
            StateHasChanged();
        }
    }

    private (string text, string badgeClass, string icon) GetTrendIndicator()
    {
        if (_historyData is null || _historyData.Count < 7)
            return (string.Empty, string.Empty, string.Empty);

        var recentDays = _historyData.TakeLast(7).ToList();
        var olderDays = _historyData.SkipLast(7).TakeLast(7).ToList();

        if (olderDays.Count < 3)
            return (string.Empty, string.Empty, string.Empty);

        var recentAvg = recentDays.Average(d => d.DegreeHeatingWeek);
        var olderAvg = olderDays.Average(d => d.DegreeHeatingWeek);
        var change = recentAvg - olderAvg;

        return change switch
        {
            > 1.0 => ("Rising quickly", "bg-danger", "bi-arrow-up-circle-fill"),
            > 0.5 => ("Rising", "bg-warning text-dark", "bi-arrow-up"),
            < -1.0 => ("Improving quickly", "bg-success", "bi-arrow-down-circle-fill"),
            < -0.5 => ("Improving", "bg-info", "bi-arrow-down"),
            _ => ("Stable", "bg-secondary", "bi-dash")
        };
    }
}
