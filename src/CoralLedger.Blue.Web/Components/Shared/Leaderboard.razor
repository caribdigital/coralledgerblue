@rendermode InteractiveServer
@using CoralLedger.Blue.Application.Features.Gamification.Queries.GetLeaderboard
@using CoralLedger.Blue.Application.Common.Interfaces
@using CoralLedger.Blue.Domain.Enums
@using MediatR

@inject IMediator Mediator
@inject ICurrentUser CurrentUser

<div class="leaderboard-component">
    <div class="leaderboard-tabs">
        <button class="tab-button @(GetTabClass(LeaderboardPeriod.Weekly))" 
                @onclick="() => SelectPeriod(LeaderboardPeriod.Weekly)">
            Weekly
        </button>
        <button class="tab-button @(GetTabClass(LeaderboardPeriod.Monthly))" 
                @onclick="() => SelectPeriod(LeaderboardPeriod.Monthly)">
            Monthly
        </button>
        <button class="tab-button @(GetTabClass(LeaderboardPeriod.AllTime))" 
                @onclick="() => SelectPeriod(LeaderboardPeriod.AllTime)">
            All Time
        </button>
    </div>

    <div class="leaderboard-content">
        @if (_isLoading)
        {
            <div class="loading-state">
                <div class="spinner"></div>
                <span>Loading leaderboard...</span>
            </div>
        }
        else if (_leaderboard?.Entries != null && _leaderboard.Entries.Any())
        {
            <div class="leaderboard-entries">
                @foreach (var entry in _leaderboard.Entries.Take(10))
                {
                    var isCurrentUser = CurrentUser.Email == entry.CitizenEmail;
                    <div class="leaderboard-entry @(isCurrentUser ? "current-user" : "") @GetRankClass(entry.Rank)">
                        <div class="entry-rank">
                            @if (entry.Rank <= 3)
                            {
                                <span class="rank-medal">@GetRankMedal(entry.Rank)</span>
                            }
                            else
                            {
                                <span class="rank-number">@entry.Rank</span>
                            }
                        </div>
                        
                        <div class="entry-avatar">
                            @GetUserInitials(entry.CitizenName ?? entry.CitizenEmail)
                        </div>
                        
                        <div class="entry-info">
                            <div class="entry-name">
                                @(entry.CitizenName ?? entry.CitizenEmail)
                                @if (isCurrentUser)
                                {
                                    <span class="you-badge">You</span>
                                }
                            </div>
                            <div class="entry-stats">
                                <span class="tier-badge tier-@(entry.Tier.ToString().ToLower())">
                                    @entry.Tier
                                </span>
                                <span class="verified-count">@entry.VerifiedObservations verified</span>
                            </div>
                        </div>
                        
                        <div class="entry-points">
                            <span class="points-value">@entry.Points</span>
                            <span class="points-label">pts</span>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="empty-state">
                <i class="bi bi-trophy"></i>
                <p>No leaderboard data available yet.</p>
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public LeaderboardPeriod InitialPeriod { get; set; } = LeaderboardPeriod.Weekly;

    private LeaderboardPeriod _selectedPeriod;
    private LeaderboardDto? _leaderboard;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        _selectedPeriod = InitialPeriod;
        await LoadLeaderboardAsync();
    }

    private async Task SelectPeriod(LeaderboardPeriod period)
    {
        if (_selectedPeriod == period) return;
        
        _selectedPeriod = period;
        await LoadLeaderboardAsync();
    }

    private async Task LoadLeaderboardAsync()
    {
        _isLoading = true;
        try
        {
            _leaderboard = await Mediator.Send(new GetLeaderboardQuery(_selectedPeriod, PageSize: 10, PageNumber: 1));
        }
        catch
        {
            _leaderboard = null;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string GetTabClass(LeaderboardPeriod period) => 
        _selectedPeriod == period ? "active" : "";

    private string GetRankClass(int rank) => rank switch
    {
        1 => "rank-1",
        2 => "rank-2",
        3 => "rank-3",
        _ => ""
    };

    private string GetRankMedal(int rank) => rank switch
    {
        1 => "ðŸ¥‡",
        2 => "ðŸ¥ˆ",
        3 => "ðŸ¥‰",
        _ => ""
    };

    private string GetUserInitials(string nameOrEmail)
    {
        if (string.IsNullOrEmpty(nameOrEmail)) return "?";
        
        var parts = nameOrEmail.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
        {
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        }
        return nameOrEmail[0].ToString().ToUpper();
    }
}
