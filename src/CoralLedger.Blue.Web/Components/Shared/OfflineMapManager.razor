@inject IJSRuntime JS
@implements IAsyncDisposable

<div class="offline-map-manager card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="bi bi-download"></i> Offline Maps
        </h5>
        <button class="btn btn-sm btn-outline-secondary" @onclick="RefreshStats">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
    </div>
    
    <div class="card-body">
        @if (_loading)
        {
            <div class="text-center py-3">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 mb-0 text-muted">Loading cache information...</p>
            </div>
        }
        else
        {
            <!-- Cache Statistics -->
            <div class="cache-stats mb-4">
                <h6 class="text-muted mb-3">Cache Statistics</h6>
                <div class="row g-2">
                    <div class="col-6">
                        <div class="stat-card p-3 bg-light rounded">
                            <div class="stat-label text-muted small">Total Tiles</div>
                            <div class="stat-value h4 mb-0">@_stats?.totalTiles.ToString("N0")</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-card p-3 bg-light rounded">
                            <div class="stat-label text-muted small">Storage Used</div>
                            <div class="stat-value h4 mb-0">@(_stats?.totalMB.ToString("F1")) MB</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Download Region Section -->
            <div class="download-section mb-4">
                <h6 class="text-muted mb-3">Download Map Tiles</h6>
                
                <div class="mb-3">
                    <label class="form-label small">Theme</label>
                    <select class="form-select form-select-sm" @bind="_selectedTheme">
                        <option value="dark">Dark (CartoDB)</option>
                        <option value="light">Light (OpenStreetMap)</option>
                        <option value="satellite">Satellite (Esri)</option>
                    </select>
                </div>

                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label class="form-label small">Min Zoom</label>
                        <input type="number" class="form-control form-control-sm" 
                               @bind="_minZoom" min="0" max="19" />
                    </div>
                    <div class="col-6">
                        <label class="form-label small">Max Zoom</label>
                        <input type="number" class="form-control form-control-sm" 
                               @bind="_maxZoom" min="0" max="19" />
                    </div>
                </div>

                @if (_estimate != null)
                {
                    <div class="alert alert-info py-2 small mb-3">
                        <strong>Estimated:</strong> @_estimate.tileCount tiles (~@_estimate.estimatedMB MB)
                    </div>
                }

                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-sm" 
                            @onclick="EstimateCurrentView"
                            disabled="@(_downloading)">
                        <i class="bi bi-calculator"></i> Estimate Current View
                    </button>
                    
                    <button class="btn btn-success btn-sm" 
                            @onclick="DownloadCurrentView"
                            disabled="@(_downloading || _estimate == null)">
                        @if (_downloading)
                        {
                            <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                            <span>Downloading... @_progress?.percentComplete%</span>
                        }
                        else
                        {
                            <i class="bi bi-download"></i>
                            <span>Download Current View</span>
                        }
                    </button>
                </div>

                @if (_progress != null && _downloading)
                {
                    <div class="progress mt-3" style="height: 20px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             style="width: @(_progress.percentComplete)%"
                             aria-valuenow="@_progress.percentComplete" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            @_progress.current / @_progress.total tiles
                        </div>
                    </div>
                    
                    <div class="mt-2 small text-muted">
                        Downloaded: @_progress.downloaded | Cached: @_progress.cached | Failed: @_progress.failed
                    </div>
                }

                @if (_downloadComplete)
                {
                    <div class="alert alert-success mt-3 py-2 small">
                        <i class="bi bi-check-circle"></i> Download complete! 
                        @_lastResult?.downloaded new tiles downloaded.
                    </div>
                }
            </div>

            <!-- Cached Regions -->
            @if (_cachedRegions != null && _cachedRegions.Any())
            {
                <div class="cached-regions mb-4">
                    <h6 class="text-muted mb-3">Cached Regions</h6>
                    <div class="list-group list-group-flush">
                        @foreach (var region in _cachedRegions)
                        {
                            <div class="list-group-item px-0 py-2">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <div class="fw-medium">@region.theme (Zoom @region.zoom)</div>
                                        <small class="text-muted">
                                            @region.tileCount tiles Â· @((region.bytes / 1024.0 / 1024.0).ToString("F1")) MB
                                        </small>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Management Actions -->
            <div class="management-actions">
                <h6 class="text-muted mb-3">Manage Cache</h6>
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-warning btn-sm" 
                            @onclick="ClearOldTiles"
                            disabled="@(_downloading)">
                        <i class="bi bi-clock-history"></i> Clear Tiles Older Than 30 Days
                    </button>
                    
                    <button class="btn btn-outline-danger btn-sm" 
                            @onclick="ClearAllCache"
                            disabled="@(_downloading)">
                        <i class="bi bi-trash"></i> Clear All Cache
                    </button>
                </div>
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public string MapId { get; set; } = "map";

    private IJSObjectReference? _jsModule;
    private DotNetObjectReference<OfflineMapManager>? _dotNetRef;
    
    private bool _loading = true;
    private bool _downloading = false;
    private bool _downloadComplete = false;
    
    private CacheStats? _stats;
    private DownloadProgress? _progress;
    private DownloadResult? _lastResult;
    private EstimateResult? _estimate;
    private List<CachedRegion>? _cachedRegions;
    
    private string _selectedTheme = "dark";
    private int _minZoom = 8;
    private int _maxZoom = 13;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            await RefreshStats();
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task RefreshStats()
    {
        try
        {
            _stats = await JS.InvokeAsync<CacheStats>("leafletMap.getCacheStats");
            _cachedRegions = await JS.InvokeAsync<List<CachedRegion>>("leafletMap.getCachedRegions");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error refreshing stats: {ex.Message}");
        }
    }

    private async Task EstimateCurrentView()
    {
        try
        {
            _estimate = await JS.InvokeAsync<EstimateResult>(
                "leafletMap.estimateCurrentViewSize",
                MapId,
                _minZoom,
                _maxZoom
            );
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error estimating size: {ex.Message}");
        }
    }

    private async Task DownloadCurrentView()
    {
        _downloading = true;
        _downloadComplete = false;
        _progress = null;
        StateHasChanged();

        try
        {
            _lastResult = await JS.InvokeAsync<DownloadResult>(
                "leafletMap.downloadCurrentView",
                MapId,
                _minZoom,
                _maxZoom,
                _dotNetRef
            );

            _downloadComplete = true;
            await RefreshStats();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error downloading tiles: {ex.Message}");
        }
        finally
        {
            _downloading = false;
            StateHasChanged();
        }
    }

    [JSInvokable]
    public void OnDownloadProgress(DownloadProgress progress)
    {
        _progress = progress;
        StateHasChanged();
    }

    private async Task ClearOldTiles()
    {
        try
        {
            var deleted = await JS.InvokeAsync<int>("leafletMap.clearOldTiles", 30);
            await RefreshStats();
            Console.WriteLine($"Cleared {deleted} old tiles");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error clearing old tiles: {ex.Message}");
        }
    }

    private async Task ClearAllCache()
    {
        if (await JS.InvokeAsync<bool>("confirm", "Are you sure you want to clear all cached map tiles?"))
        {
            try
            {
                await JS.InvokeAsync<bool>("leafletMap.clearAllCache");
                await RefreshStats();
                _estimate = null;
                Console.WriteLine("Cache cleared");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error clearing cache: {ex.Message}");
            }
        }
    }

    public async ValueTask DisposeAsync()
    {
        _dotNetRef?.Dispose();
        
        if (_jsModule != null)
        {
            await _jsModule.DisposeAsync();
        }
    }

    // Models for JS interop
    private class CacheStats
    {
        public int totalTiles { get; set; }
        public long totalBytes { get; set; }
        public double totalMB { get; set; }
        public long? lastUpdated { get; set; }
    }

    private class DownloadProgress
    {
        public int current { get; set; }
        public int total { get; set; }
        public int downloaded { get; set; }
        public int cached { get; set; }
        public int failed { get; set; }
        public int percentComplete { get; set; }
        public long totalBytes { get; set; }
    }

    private class DownloadResult
    {
        public int total { get; set; }
        public int downloaded { get; set; }
        public int cached { get; set; }
        public int failed { get; set; }
        public long totalBytes { get; set; }
    }

    private class EstimateResult
    {
        public int tileCount { get; set; }
        public long estimatedBytes { get; set; }
        public double estimatedMB { get; set; }
    }

    private class CachedRegion
    {
        public string theme { get; set; } = "";
        public int zoom { get; set; }
        public int tileCount { get; set; }
        public long bytes { get; set; }
    }
}
