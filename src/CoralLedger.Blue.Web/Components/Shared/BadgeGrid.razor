@using CoralLedger.Blue.Domain.Enums
@using CoralLedger.Blue.Application.Features.Gamification.Queries.GetUserProfile
@using CoralLedger.Blue.Web.Services

<div class="badge-grid">
    @if (Badges != null && Badges.Any())
    {
        @foreach (var badge in Badges)
        {
            <div class="badge-card earned @(IsNewlyEarned(badge) ? "newly-earned" : "")" 
                 title="@BadgeDisplayHelper.GetBadgeDescription(badge.BadgeType)">
                <div class="badge-icon">
                    @BadgeDisplayHelper.GetBadgeIcon(badge.BadgeType)
                </div>
                <div class="badge-name">@BadgeDisplayHelper.GetBadgeName(badge.BadgeType)</div>
                <div class="badge-earned-date">@badge.EarnedAt.ToString("MMM dd, yyyy")</div>
            </div>
        }
    }
    
    @if (ShowLockedBadges)
    {
        @foreach (var badgeType in GetLockedBadges())
        {
            <div class="badge-card locked" title="@BadgeDisplayHelper.GetBadgeRequirement(badgeType)">
                <div class="badge-icon">
                    <i class="bi bi-lock-fill"></i>
                </div>
                <div class="badge-name">@BadgeDisplayHelper.GetBadgeName(badgeType)</div>
                <div class="badge-requirement">@BadgeDisplayHelper.GetBadgeRequirement(badgeType)</div>
            </div>
        }
    }
</div>

@code {
    [Parameter]
    public List<BadgeDto>? Badges { get; set; }

    [Parameter]
    public bool ShowLockedBadges { get; set; } = true;

    [Parameter]
    public DateTime? NewBadgeEarnedSince { get; set; }

    private bool IsNewlyEarned(BadgeDto badge)
    {
        if (NewBadgeEarnedSince == null) return false;
        return badge.EarnedAt >= NewBadgeEarnedSince.Value;
    }

    private IEnumerable<BadgeType> GetLockedBadges()
    {
        var earnedBadgeTypes = Badges?.Select(b => b.BadgeType).ToHashSet() ?? new HashSet<BadgeType>();
        return Enum.GetValues<BadgeType>().Where(bt => !earnedBadgeTypes.Contains(bt));
    }
}
