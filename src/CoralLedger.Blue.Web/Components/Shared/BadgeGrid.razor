@using CoralLedger.Blue.Domain.Enums
@using CoralLedger.Blue.Application.Features.Gamification.Queries.GetUserProfile

<div class="badge-grid">
    @if (Badges != null && Badges.Any())
    {
        @foreach (var badge in Badges)
        {
            <div class="badge-card earned @(IsNewlyEarned(badge) ? "newly-earned" : "")" 
                 title="@GetBadgeDescription(badge.BadgeType)">
                <div class="badge-icon">
                    @GetBadgeIcon(badge.BadgeType)
                </div>
                <div class="badge-name">@GetBadgeName(badge.BadgeType)</div>
                <div class="badge-earned-date">@badge.EarnedAt.ToString("MMM dd, yyyy")</div>
            </div>
        }
    }
    
    @if (ShowLockedBadges)
    {
        @foreach (var badgeType in GetLockedBadges())
        {
            <div class="badge-card locked" title="@GetBadgeRequirement(badgeType)">
                <div class="badge-icon">
                    <i class="bi bi-lock-fill"></i>
                </div>
                <div class="badge-name">@GetBadgeName(badgeType)</div>
                <div class="badge-requirement">@GetBadgeRequirement(badgeType)</div>
            </div>
        }
    }
</div>

@code {
    [Parameter]
    public List<BadgeDto>? Badges { get; set; }

    [Parameter]
    public bool ShowLockedBadges { get; set; } = true;

    [Parameter]
    public DateTime? NewBadgeEarnedSince { get; set; }

    private bool IsNewlyEarned(BadgeDto badge)
    {
        if (NewBadgeEarnedSince == null) return false;
        return badge.EarnedAt >= NewBadgeEarnedSince.Value;
    }

    private IEnumerable<BadgeType> GetLockedBadges()
    {
        var earnedBadgeTypes = Badges?.Select(b => b.BadgeType).ToHashSet() ?? new HashSet<BadgeType>();
        return Enum.GetValues<BadgeType>().Where(bt => !earnedBadgeTypes.Contains(bt));
    }

    private string GetBadgeIcon(BadgeType badge) => badge switch
    {
        BadgeType.FirstObservation => "ðŸŒŠ",
        BadgeType.FirstVerifiedObservation => "âœ…",
        BadgeType.TenObservations => "ðŸ”Ÿ",
        BadgeType.FiftyObservations => "5ï¸âƒ£0ï¸âƒ£",
        BadgeType.HundredObservations => "ðŸ’¯",
        BadgeType.SpeciesExpert => "ðŸ ",
        BadgeType.CoralExpert => "ðŸª¸",
        BadgeType.FishExpert => "ðŸŸ",
        BadgeType.PhotoPro => "ðŸ“·",
        BadgeType.AccurateObserver => "ðŸŽ¯",
        BadgeType.WeeklyContributor => "ðŸ“…",
        BadgeType.MonthlyContributor => "ðŸ—“ï¸",
        BadgeType.YearlyContributor => "ðŸ“†",
        BadgeType.MPAGuardian => "ðŸ›¡ï¸",
        BadgeType.BleachingDetector => "ðŸŒ¡ï¸",
        BadgeType.DebrisWarrior => "â™»ï¸",
        BadgeType.Helpful => "ðŸ¤",
        BadgeType.Educator => "ðŸŽ“",
        _ => "â­"
    };

    private string GetBadgeName(BadgeType badge) => badge switch
    {
        BadgeType.FirstObservation => "First Observation",
        BadgeType.FirstVerifiedObservation => "First Verified",
        BadgeType.TenObservations => "10 Observations",
        BadgeType.FiftyObservations => "50 Observations",
        BadgeType.HundredObservations => "100 Observations",
        BadgeType.SpeciesExpert => "Species Expert",
        BadgeType.CoralExpert => "Coral Expert",
        BadgeType.FishExpert => "Fish Expert",
        BadgeType.PhotoPro => "Photo Pro",
        BadgeType.AccurateObserver => "Accurate Observer",
        BadgeType.WeeklyContributor => "Weekly Contributor",
        BadgeType.MonthlyContributor => "Monthly Contributor",
        BadgeType.YearlyContributor => "Yearly Contributor",
        BadgeType.MPAGuardian => "MPA Guardian",
        BadgeType.BleachingDetector => "Bleaching Detector",
        BadgeType.DebrisWarrior => "Debris Warrior",
        BadgeType.Helpful => "Helpful",
        BadgeType.Educator => "Educator",
        _ => badge.ToString()
    };

    private string GetBadgeDescription(BadgeType badge) => badge switch
    {
        BadgeType.FirstObservation => "Submitted your first marine observation",
        BadgeType.FirstVerifiedObservation => "Had your first observation verified by moderators",
        BadgeType.TenObservations => "Submitted 10 marine observations",
        BadgeType.FiftyObservations => "Submitted 50 marine observations",
        BadgeType.HundredObservations => "Submitted 100 marine observations",
        BadgeType.SpeciesExpert => "Identified multiple species with high accuracy",
        BadgeType.CoralExpert => "Specialized knowledge in coral identification",
        BadgeType.FishExpert => "Specialized knowledge in fish identification",
        BadgeType.PhotoPro => "Submitted high-quality photos consistently",
        BadgeType.AccurateObserver => "Maintained 90%+ observation accuracy",
        BadgeType.WeeklyContributor => "Contributed observations every week for a month",
        BadgeType.MonthlyContributor => "Contributed observations every month for a year",
        BadgeType.YearlyContributor => "Active contributor for over a year",
        BadgeType.MPAGuardian => "Frequent contributor to MPA monitoring",
        BadgeType.BleachingDetector => "Reported coral bleaching events",
        BadgeType.DebrisWarrior => "Reported marine debris consistently",
        BadgeType.Helpful => "Helped other users with feedback and guidance",
        BadgeType.Educator => "Contributed educational content or outreach",
        _ => "Special achievement badge"
    };

    private string GetBadgeRequirement(BadgeType badge) => badge switch
    {
        BadgeType.FirstObservation => "Submit 1 observation",
        BadgeType.FirstVerifiedObservation => "Get 1 observation verified",
        BadgeType.TenObservations => "Submit 10 observations",
        BadgeType.FiftyObservations => "Submit 50 observations",
        BadgeType.HundredObservations => "Submit 100 observations",
        BadgeType.SpeciesExpert => "Identify 20+ unique species",
        BadgeType.CoralExpert => "25+ verified coral observations",
        BadgeType.FishExpert => "25+ verified fish observations",
        BadgeType.PhotoPro => "Upload 50+ quality photos",
        BadgeType.AccurateObserver => "Maintain 90%+ accuracy",
        BadgeType.WeeklyContributor => "4 consecutive weeks",
        BadgeType.MonthlyContributor => "12 consecutive months",
        BadgeType.YearlyContributor => "Active for 365+ days",
        BadgeType.MPAGuardian => "50+ MPA observations",
        BadgeType.BleachingDetector => "Report 5+ bleaching events",
        BadgeType.DebrisWarrior => "Report 10+ debris incidents",
        BadgeType.Helpful => "Awarded by moderators",
        BadgeType.Educator => "Awarded by moderators",
        _ => "Special requirement"
    };
}
