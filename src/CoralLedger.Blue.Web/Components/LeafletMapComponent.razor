@using System.Text.Json
@using CoralLedger.Blue.Web.Theme
@using Microsoft.JSInterop
@inject IJSRuntime JS
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager NavigationManager
@inject IThemeState ThemeState
@implements IAsyncDisposable
@implements IDisposable

<div class="leaflet-map-container" style="height: calc(100vh - 200px); min-height: 500px; width: 100%; position: relative;">
    @if (_loading)
    {
        <div class="loading-overlay">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading map...</span>
            </div>
        </div>
    }

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert alert-danger m-3" role="alert">
            <i class="bi bi-exclamation-triangle"></i> @_errorMessage
        </div>
    }

    @if (_mpaLoadError)
    {
        <div class="alert alert-warning m-3" role="alert">
            <i class="bi bi-exclamation-triangle"></i> @_mpaLoadErrorMessage
            <button class="btn btn-sm btn-outline-warning ms-2" @onclick="RetryLoadMpaDataAsync">
                <i class="bi bi-arrow-clockwise"></i> Retry
            </button>
        </div>
    }

    <div id="@_mapId" style="height: 100%; width: 100%;" role="application" aria-label="Interactive map of Bahamas Marine Protected Areas"></div>

    @* US-2.2.3: Map Control Panel with theme toggle - appears on hover *@
    @if (_mapInitialized && !_loading)
    {
        <div class="map-tile-toggle">
            <button type="button"
                    class="tile-toggle-btn"
                    @onclick="ToggleTheme"
                    title="@(UseDarkTheme ? "Switch to light map tiles" : "Switch to dark map tiles")"
                    aria-label="@(UseDarkTheme ? "Switch to light map tiles" : "Switch to dark map tiles")">
                <i class="bi @(UseDarkTheme ? "bi-sun-fill" : "bi-moon-fill")"></i>
                <span>@(UseDarkTheme ? "Light" : "Dark")</span>
            </button>
        </div>
    }

    @if (_mpaCount > 0 && !_loading)
    {
        <div class="mpa-count-badge">
            <i class="bi bi-geo-alt-fill"></i> @_mpaCount MPAs loaded
        </div>
    }

    @if (ShowFishingEvents && _fishingEventsCount > 0)
    {
        <div class="fishing-events-badge">
            <i class="bi bi-water"></i> @_fishingEventsCount fishing events
        </div>
    }
    else if (ShowFishingEvents && _fishingEventsNoData)
    {
        <div class="fishing-events-badge no-data">
            <i class="bi bi-info-circle"></i> No fishing events in last 30 days
        </div>
    }
</div>

<style>
    .leaflet-map-container {
        position: relative;
        min-height: 500px;
    }

    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(5, 12, 26, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    /* US-2.2.3: Map tile toggle - positioned top-right, visible on hover */
    .map-tile-toggle {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.25s ease-in-out;
    }

    .leaflet-map-container:hover .map-tile-toggle,
    .map-tile-toggle:hover,
    .map-tile-toggle:focus-within {
        opacity: 1;
    }

    /* Button always has solid background for visibility on any map */
    .tile-toggle-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: var(--color-surface-alt, #ffffff);
        border: 2px solid var(--color-primary, #2EE3FF);
        border-radius: 6px;
        padding: 6px 12px;
        color: var(--color-primary, #2EE3FF);
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 600;
        font-family: inherit;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
        transition: all 0.2s ease;
    }

    .tile-toggle-btn:hover {
        background: var(--color-primary, #2EE3FF);
        color: var(--color-surface, #050C1A);
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.35);
    }

    .tile-toggle-btn:focus {
        outline: 2px solid var(--color-primary, #2EE3FF);
        outline-offset: 2px;
    }

    .tile-toggle-btn i {
        font-size: 0.9rem;
    }

    .tile-toggle-btn span {
        white-space: nowrap;
    }

    /* Light theme overrides for better contrast */
    :global(:root[data-theme='light']) .tile-toggle-btn {
        background: #ffffff;
        border-color: var(--color-primary, #1A6BFF);
        color: var(--color-primary, #1A6BFF);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    :global(:root[data-theme='light']) .tile-toggle-btn:hover {
        background: var(--color-primary, #1A6BFF);
        color: #ffffff;
    }

    .mpa-count-badge {
        position: absolute;
        top: 10px;
        left: 60px;
        background: rgba(5, 12, 26, 0.92);
        backdrop-filter: blur(8px);
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--color-success, #5DE285);
        border: 1px solid var(--color-border, rgba(255,255,255,0.18));
        z-index: 999;
    }

    .mpa-count-badge i {
        margin-right: 4px;
    }

    .fishing-events-badge {
        position: absolute;
        top: 45px;
        left: 60px;
        background: rgba(5, 12, 26, 0.92);
        backdrop-filter: blur(8px);
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--color-primary, #2EE3FF);
        border: 1px solid var(--color-border, rgba(255,255,255,0.18));
        z-index: 999;
    }

    .fishing-events-badge.no-data {
        color: var(--color-text-muted, rgba(245,251,255,0.7));
    }

    .fishing-events-badge i {
        margin-right: 4px;
    }
</style>

@code {
    [Parameter]
    public EventCallback<Guid> OnMpaSelected { get; set; }

    [Parameter]
    public Guid? SelectedMpaId { get; set; }

    [Parameter]
    public bool ShowLegend { get; set; } = true;

    [Parameter]
    public bool ShowFishingEvents { get; set; } = false;

    [Parameter]
    public DateTime? FishingEventsStartDate { get; set; }

    [Parameter]
    public DateTime? FishingEventsEndDate { get; set; }

    /// <summary>
    /// US-2.2.1: Use dark CartoDB tiles (default true for dark theme)
    /// </summary>
    [Parameter]
    public bool UseDarkTheme { get; set; } = true;

    private string _mapId = $"leaflet-map-{Guid.NewGuid():N}";
    private bool _loading = true;
    private string? _errorMessage;
    private bool _mapInitialized = false;
    private bool _fishingEventsLoaded = false;
    private bool _disposed = false;
    private DotNetObjectReference<LeafletMapComponent>? _dotNetRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                _dotNetRef = DotNetObjectReference.Create(this);

                // Subscribe to global theme changes
                ThemeState.ThemeChanged += OnGlobalThemeChanged;

                // US-2.2.1: Initialize map with theme - read directly from localStorage for accuracy
                var savedTheme = await JS.InvokeAsync<string>("CoralLedgerThemeManager.getMode");
                var isDark = savedTheme != "light"; // Default to dark if not explicitly light
                UseDarkTheme = isDark;
                await JS.InvokeVoidAsync("leafletMap.initialize", _mapId, 24.5, -77.5, 7, isDark);
                _mapInitialized = true;

                // Load MPA data
                await LoadMpaDataAsync();

                // US-2.2.6: Add legend to map
                if (ShowLegend)
                {
                    await JS.InvokeVoidAsync("leafletMap.addLegend", _mapId, true, ShowFishingEvents);
                }

                _loading = false;
                StateHasChanged();
            }
            catch (Exception ex)
            {
                _errorMessage = $"Map initialization failed: {ex.Message}";
                _loading = false;
                Console.WriteLine($"LeafletMapComponent error: {ex}");
                StateHasChanged();
            }
        }
    }

    /// <summary>
    /// US-2.2.3: Toggle between dark and light map themes
    /// </summary>
    private async Task ToggleTheme()
    {
        UseDarkTheme = !UseDarkTheme;
        await JS.InvokeVoidAsync("leafletMap.setTileTheme", _mapId, UseDarkTheme ? "dark" : "light");
    }

    /// <summary>
    /// Handle global theme changes from ThemeState
    /// </summary>
    private async void OnGlobalThemeChanged(ThemeMode newMode)
    {
        if (!_mapInitialized || _disposed) return;

        var isDark = newMode == ThemeMode.Dark;
        if (UseDarkTheme != isDark)
        {
            UseDarkTheme = isDark;
            try
            {
                await JS.InvokeVoidAsync("leafletMap.setTileTheme", _mapId, isDark ? "dark" : "light");
                await InvokeAsync(StateHasChanged);
            }
            catch (JSDisconnectedException)
            {
                // Circuit disconnected, component is being disposed - ignore
            }
            catch (ObjectDisposedException)
            {
                // Component disposed - ignore
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Failed to update map theme: {ex.Message}");
            }
        }
    }

    public void Dispose()
    {
        _disposed = true;
        ThemeState.ThemeChanged -= OnGlobalThemeChanged;
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!_mapInitialized || _disposed) return;

        try
        {
            // Handle MPA selection from parent
            if (SelectedMpaId.HasValue)
            {
                await JS.InvokeVoidAsync("leafletMap.zoomToMpa", _mapId, SelectedMpaId.Value.ToString());
                await JS.InvokeVoidAsync("leafletMap.highlightMpa", _mapId, SelectedMpaId.Value.ToString());
            }

            // Handle fishing events toggle
            if (ShowFishingEvents && !_fishingEventsLoaded)
            {
                await LoadFishingEventsAsync();
                // US-2.2.6: Update legend to show fishing activity
                if (ShowLegend)
                {
                    await JS.InvokeVoidAsync("leafletMap.updateLegend", _mapId, true, true);
                }
            }
            else if (!ShowFishingEvents && _fishingEventsLoaded)
            {
                await JS.InvokeVoidAsync("leafletMap.removeFishingEventsLayer", _mapId);
                _fishingEventsLoaded = false;
                _fishingEventsCount = 0;
                _fishingEventsNoData = false;
                // US-2.2.6: Update legend to hide fishing activity
                if (ShowLegend)
                {
                    await JS.InvokeVoidAsync("leafletMap.updateLegend", _mapId, true, false);
                }
            }
        }
        catch (JSDisconnectedException)
        {
            // Circuit disconnected - ignore
        }
        catch (ObjectDisposedException)
        {
            // Component disposed - ignore
        }
    }

    private bool _mpaLoadError = false;
    private string? _mpaLoadErrorMessage;
    private int _mpaCount = 0;
    private int _fishingEventsCount = 0;
    private bool _fishingEventsNoData = false;

    private async Task LoadMpaDataAsync()
    {
        try
        {
            Console.WriteLine("[LeafletMap] Loading MPA data from /api/mpas/geojson...");
            var httpClient = HttpClientFactory.CreateClient();
            httpClient.BaseAddress = new Uri(NavigationManager.BaseUri);
            var response = await httpClient.GetAsync("/api/mpas/geojson");

            if (response.IsSuccessStatusCode)
            {
                var geojson = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"[LeafletMap] GeoJSON response length: {geojson.Length} chars");

                var geojsonObj = JsonSerializer.Deserialize<JsonElement>(geojson);

                // Log the structure for debugging
                if (geojsonObj.TryGetProperty("type", out var typeElement))
                {
                    Console.WriteLine($"[LeafletMap] GeoJSON type: {typeElement.GetString()}");
                }
                if (geojsonObj.TryGetProperty("features", out var featuresElement))
                {
                    _mpaCount = featuresElement.GetArrayLength();
                    Console.WriteLine($"[LeafletMap] GeoJSON features count: {_mpaCount}");
                }

                var success = await JS.InvokeAsync<bool>("leafletMap.addMpaLayer", _mapId, geojsonObj, _dotNetRef);
                Console.WriteLine($"[LeafletMap] addMpaLayer returned: {success}");

                if (!success)
                {
                    _mpaLoadError = true;
                    _mpaLoadErrorMessage = "Failed to add MPA layer to map";
                }
            }
            else
            {
                _mpaLoadError = true;
                _mpaLoadErrorMessage = $"API returned {(int)response.StatusCode}: {response.ReasonPhrase}";
                Console.WriteLine($"[LeafletMap] API error: {_mpaLoadErrorMessage}");
            }
        }
        catch (Exception ex)
        {
            _mpaLoadError = true;
            _mpaLoadErrorMessage = $"Error loading MPA data: {ex.Message}";
            Console.WriteLine($"[LeafletMap] Exception: {ex}");
        }
    }

    private async Task RetryLoadMpaDataAsync()
    {
        _mpaLoadError = false;
        _mpaLoadErrorMessage = null;
        _mpaCount = 0;
        StateHasChanged();
        await LoadMpaDataAsync();
        StateHasChanged();
    }

    private async Task LoadFishingEventsAsync()
    {
        try
        {
            _fishingEventsNoData = false;
            _fishingEventsCount = 0;

            var start = FishingEventsStartDate ?? DateTime.UtcNow.AddDays(-30);
            var end = FishingEventsEndDate ?? DateTime.UtcNow;

            var httpClient = HttpClientFactory.CreateClient();
            httpClient.BaseAddress = new Uri(NavigationManager.BaseUri);
            var response = await httpClient.GetAsync($"/api/vessels/fishing-events/bahamas?startDate={start:O}&endDate={end:O}");
            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                var events = JsonSerializer.Deserialize<List<FishingEventDto>>(json, new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                });

                if (events != null && events.Count > 0)
                {
                    await JS.InvokeVoidAsync("leafletMap.addFishingEventsLayer", _mapId, events, _dotNetRef);
                    _fishingEventsLoaded = true;
                    _fishingEventsCount = events.Count;
                }
                else
                {
                    _fishingEventsNoData = true;
                    _fishingEventsLoaded = true; // Mark as loaded so we don't retry
                }
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading fishing events: {ex.Message}");
        }
    }

    [JSInvokable]
    public async Task OnMpaClicked(string mpaId)
    {
        if (Guid.TryParse(mpaId, out var guid))
        {
            await OnMpaSelected.InvokeAsync(guid);
        }
    }

    [JSInvokable]
    public Task OnFishingEventClicked(string eventId)
    {
        Console.WriteLine($"Fishing event clicked: {eventId}");
        return Task.CompletedTask;
    }

    public async ValueTask DisposeAsync()
    {
        _disposed = true;
        if (_mapInitialized)
        {
            try
            {
                await JS.InvokeVoidAsync("leafletMap.dispose", _mapId);
            }
            catch
            {
                // Ignore disposal errors (e.g., circuit already disconnected)
            }
        }
        _dotNetRef?.Dispose();
    }

    public class FishingEventDto
    {
        public string EventId { get; set; } = "";
        public string VesselId { get; set; } = "";
        public string? VesselName { get; set; }
        public double Longitude { get; set; }
        public double Latitude { get; set; }
        public DateTime StartTime { get; set; }
        public DateTime? EndTime { get; set; }
        public double? DurationHours { get; set; }
        public double? DistanceKm { get; set; }
        public string? EventType { get; set; }
        public bool? IsInMpa { get; set; }
        public string? MpaName { get; set; }
    }
}
