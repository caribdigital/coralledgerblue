@inject IMediator Mediator
@inject ICoralReefWatchClient CrwClient

<div class="card h-100">
    <div class="card-header bg-info text-white">
        <strong>MPA Details</strong>
    </div>
    <div class="card-body">
        @if (SelectedMpaId is null)
        {
            <p class="text-muted">Select a Marine Protected Area from the list to view details.</p>
        }
        else if (_loading)
        {
            <div class="d-flex justify-content-center">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        }
        else if (_detail is not null)
        {
            <h5 class="card-title">@_detail.Name</h5>
            @if (!string.IsNullOrEmpty(_detail.LocalName))
            {
                <p class="text-muted mb-2"><em>@_detail.LocalName</em></p>
            }

            <dl class="row small">
                <dt class="col-5">Status</dt>
                <dd class="col-7">
                    <span class="badge bg-success">@_detail.Status</span>
                </dd>

                <dt class="col-5">Protection</dt>
                <dd class="col-7">
                    <span class="badge @GetProtectionBadgeClass(_detail.ProtectionLevel)">
                        @_detail.ProtectionLevel
                    </span>
                </dd>

                <dt class="col-5">Island Group</dt>
                <dd class="col-7">@_detail.IslandGroup</dd>

                <dt class="col-5">Area</dt>
                <dd class="col-7">@_detail.AreaSquareKm.ToString("N1") km²</dd>

                @if (_detail.DesignationDate.HasValue)
                {
                    <dt class="col-5">Designated</dt>
                    <dd class="col-7">@_detail.DesignationDate.Value.Year</dd>
                }

                @if (!string.IsNullOrEmpty(_detail.ManagingAuthority))
                {
                    <dt class="col-5">Manager</dt>
                    <dd class="col-7">@_detail.ManagingAuthority</dd>
                }

                <dt class="col-5">Reefs</dt>
                <dd class="col-7">@_detail.ReefCount tracked</dd>
            </dl>

            @* Coral Bleaching Status Section *@
            <hr />
            <h6 class="mb-3"><i class="bi bi-thermometer-half text-danger"></i> Coral Bleaching Status</h6>

            @if (_bleachingLoading)
            {
                <div class="text-center py-2">
                    <div class="spinner-border spinner-border-sm text-warning" role="status">
                        <span class="visually-hidden">Loading bleaching data...</span>
                    </div>
                    <small class="text-muted d-block mt-1">Loading NOAA data...</small>
                </div>
            }
            else if (_bleachingData is not null)
            {
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <div class="card bg-light h-100">
                            <div class="card-body py-2 px-3 text-center">
                                <small class="text-muted d-block">Sea Surface Temp</small>
                                <strong class="fs-5">@_bleachingData.SeaSurfaceTemperature.ToString("F1")°C</strong>
                                @if (_bleachingData.SstAnomaly > 0)
                                {
                                    <small class="text-danger d-block">+@_bleachingData.SstAnomaly.ToString("F1")° anomaly</small>
                                }
                                else if (_bleachingData.SstAnomaly < 0)
                                {
                                    <small class="text-info d-block">@_bleachingData.SstAnomaly.ToString("F1")° anomaly</small>
                                }
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card bg-light h-100">
                            <div class="card-body py-2 px-3 text-center">
                                <small class="text-muted d-block">Degree Heating Week</small>
                                <strong class="fs-5 @GetDhwTextClass(_bleachingData.DegreeHeatingWeek)">
                                    @_bleachingData.DegreeHeatingWeek.ToString("F1")
                                </strong>
                                <small class="text-muted d-block">°C-weeks</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Alert Level:</span>
                    <span class="badge @GetAlertBadgeClass(_bleachingData.AlertLevel)">
                        @GetAlertLevelName(_bleachingData.AlertLevel)
                    </span>
                </div>

                @if (_bleachingData.HotSpot.HasValue && _bleachingData.HotSpot.Value > 0)
                {
                    <div class="alert alert-warning py-2 mb-2 small">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        HotSpot detected: +@_bleachingData.HotSpot.Value.ToString("F1")°C above threshold
                    </div>
                }

                <small class="text-muted d-block">
                    <i class="bi bi-clock"></i> Data from @_bleachingData.Date.ToString("yyyy-MM-dd")
                </small>
                <small class="text-muted d-block">
                    <i class="bi bi-geo-alt"></i> @_detail.CentroidLatitude.ToString("F2")°N, @Math.Abs(_detail.CentroidLongitude).ToString("F2")°W
                </small>
            }
            else
            {
                <div class="alert alert-secondary py-2 small">
                    <i class="bi bi-info-circle"></i> Bleaching data unavailable for this location
                </div>
            }

            @* Historical DHW Trend Section *@
            @if (_historyLoading)
            {
                <hr />
                <div class="text-center py-2">
                    <div class="spinner-border spinner-border-sm text-secondary" role="status">
                        <span class="visually-hidden">Loading history...</span>
                    </div>
                    <small class="text-muted d-block mt-1">Loading trend data...</small>
                </div>
            }
            else if (_historyData?.Count > 1)
            {
                <hr />
                <h6 class="mb-2">
                    <i class="bi bi-graph-up"></i> 30-Day DHW Trend
                </h6>
                <DhwSparkline Data="@_historyData" Height="60" ShowLegend="true" />
                <div class="d-flex justify-content-between small text-muted mt-1">
                    <span>@_historyData.First().Date.ToString("MMM d")</span>
                    <span>@_historyData.Last().Date.ToString("MMM d")</span>
                </div>
                @if (!string.IsNullOrEmpty(GetTrendIndicator().text))
                {
                    <div class="mt-2">
                        <span class="badge @GetTrendIndicator().badgeClass">
                            <i class="bi @GetTrendIndicator().icon"></i> @GetTrendIndicator().text
                        </span>
                    </div>
                }
            }
            else if (_historyData?.Count == 1)
            {
                <hr />
                <div class="alert alert-info py-2 small mb-0">
                    <i class="bi bi-info-circle"></i> Only 1 day of historical data available. Trend chart requires at least 2 days.
                </div>
            }

            @if (!string.IsNullOrEmpty(_detail.Description))
            {
                <hr />
                <p class="small">@_detail.Description</p>
            }

            @if (!string.IsNullOrEmpty(_detail.WdpaId))
            {
                <hr />
                <p class="small text-muted mb-0">
                    WDPA ID: @_detail.WdpaId
                </p>
            }

            <hr />
            <small class="text-muted">
                <a href="https://coralreefwatch.noaa.gov" target="_blank" class="text-decoration-none">
                    <i class="bi bi-box-arrow-up-right"></i> NOAA Coral Reef Watch
                </a>
            </small>
        }
        else
        {
            <p class="text-danger">Failed to load MPA details.</p>
        }
    </div>
</div>

@code {
    [Parameter]
    public Guid? SelectedMpaId { get; set; }

    private MpaDetailDto? _detail;
    private bool _loading;
    private Guid? _loadedMpaId;
    private CrwBleachingData? _bleachingData;
    private bool _bleachingLoading;
    private IReadOnlyList<BleachingHistoryDto>? _historyData;
    private bool _historyLoading;

    protected override async Task OnParametersSetAsync()
    {
        if (SelectedMpaId != _loadedMpaId && SelectedMpaId.HasValue)
        {
            _loading = true;
            _bleachingData = null;
            _historyData = null;
            _detail = await Mediator.Send(new GetMpaByIdQuery(SelectedMpaId.Value));
            _loadedMpaId = SelectedMpaId;
            _loading = false;

            // Load bleaching data and history asynchronously after MPA details
            await Task.WhenAll(
                LoadBleachingDataAsync(),
                LoadHistoryDataAsync());
        }
        else if (!SelectedMpaId.HasValue)
        {
            _detail = null;
            _loadedMpaId = null;
            _bleachingData = null;
            _historyData = null;
        }
    }

    private async Task LoadBleachingDataAsync()
    {
        if (_detail is null) return;

        try
        {
            _bleachingLoading = true;
            StateHasChanged();

            var yesterday = DateOnly.FromDateTime(DateTime.UtcNow.AddDays(-1));
            _bleachingData = await CrwClient.GetBleachingDataAsync(
                _detail.CentroidLongitude,
                _detail.CentroidLatitude,
                yesterday);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading bleaching data: {ex.Message}");
            _bleachingData = null;
        }
        finally
        {
            _bleachingLoading = false;
            StateHasChanged();
        }
    }

    private string GetProtectionBadgeClass(string level) => level switch
    {
        "NoTake" => "bg-danger",
        "HighlyProtected" => "bg-warning text-dark",
        "LightlyProtected" => "bg-info",
        _ => "bg-secondary"
    };

    private string GetAlertLevelName(int level) => level switch
    {
        0 => "No Stress",
        1 => "Watch",
        2 => "Warning",
        3 => "Alert Level 1",
        4 => "Alert Level 2",
        _ => $"Alert Level {level - 2}"
    };

    private string GetAlertBadgeClass(int level) => level switch
    {
        0 => "bg-success",
        1 => "bg-info",
        2 => "bg-warning text-dark",
        >= 3 => "bg-danger",
        _ => "bg-secondary"
    };

    private string GetDhwTextClass(double dhw) => dhw switch
    {
        >= 8 => "text-danger",
        >= 4 => "text-warning",
        >= 1 => "text-info",
        _ => "text-success"
    };

    private async Task LoadHistoryDataAsync()
    {
        if (_loadedMpaId is null) return;

        try
        {
            _historyLoading = true;
            StateHasChanged();

            _historyData = await Mediator.Send(new GetMpaBleachingHistoryQuery(_loadedMpaId.Value, 30));
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading history data: {ex.Message}");
            _historyData = null;
        }
        finally
        {
            _historyLoading = false;
            StateHasChanged();
        }
    }

    private (string text, string badgeClass, string icon) GetTrendIndicator()
    {
        if (_historyData is null || _historyData.Count < 7)
            return (string.Empty, string.Empty, string.Empty);

        // Compare last 7 days average to previous 7 days
        var recentDays = _historyData.TakeLast(7).ToList();
        var olderDays = _historyData.SkipLast(7).TakeLast(7).ToList();

        if (olderDays.Count < 3)
            return (string.Empty, string.Empty, string.Empty);

        var recentAvg = recentDays.Average(d => d.DegreeHeatingWeek);
        var olderAvg = olderDays.Average(d => d.DegreeHeatingWeek);
        var change = recentAvg - olderAvg;

        return change switch
        {
            > 1.0 => ("Rising quickly", "bg-danger", "bi-arrow-up-circle-fill"),
            > 0.5 => ("Rising", "bg-warning text-dark", "bi-arrow-up"),
            < -1.0 => ("Improving quickly", "bg-success", "bi-arrow-down-circle-fill"),
            < -0.5 => ("Improving", "bg-info", "bi-arrow-down"),
            _ => ("Stable", "bg-secondary", "bi-dash")
        };
    }
}
